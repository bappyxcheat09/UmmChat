<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UmmChat Login & Chat</title>
<style>
  body {
    margin:0; padding:0; font-family:sans-serif; background:#111; color:#eee; display:flex; justify-content:center; align-items:center; height:100vh;
  }
  #login, #chat {
    width: 100%; max-width: 400px; background:#222; padding:20px; border-radius:8px; box-sizing:border-box;
  }
  #login {
    display: flex; flex-direction: column; gap: 10px;
  }
  input {
    padding:10px; border-radius:5px; border:none; font-size:16px;
    background:#333; color:#eee;
  }
  button {
    padding:10px; border:none; border-radius:5px; background:#25D366; color:#fff; font-weight:bold; cursor:pointer;
  }
  #chat {
    display:none; flex-direction: column; height: 90vh;
  }
  #messages {
    flex:1; overflow-y:auto; margin-bottom:10px; border:1px solid #333; padding:10px; border-radius:5px; background:#222;
  }
  .msg {
    padding:8px 12px; border-radius:12px; margin-bottom:8px; max-width:75%; word-wrap:break-word;
  }
  .me { background:#056162; align-self:flex-end; }
  .friend { background:#2a3942; align-self:flex-start; }
  #inputArea {
    display:flex; gap:8px;
  }
  #msgInput {
    flex:1; padding:10px; border-radius:20px; border:none; background:#333; color:#eee; font-size:16px;
  }
  #emojiBtn {
    cursor:pointer; font-size:24px; user-select:none; color:#25D366; display:flex; align-items:center; justify-content:center; width:40px; background:#111; border-radius:50%;
  }
  #emojiPanel {
    background:#2a3942; border-radius:8px; max-height:120px; overflow-y:auto; padding:5px; margin-bottom:10px; display:none;
  }
  #emojiPanel span {
    font-size:22px; padding:5px; cursor:pointer;
  }
</style>
</head>
<body>

<div id="login">
  <h2>Login to UmmChat</h2>
  <input id="username" placeholder="Username" autocomplete="off" />
  <input id="password" type="password" placeholder="Password" autocomplete="off" />
  <button id="loginBtn">Login</button>
  <p id="loginMsg" style="color:#f66;"></p>
</div>

<div id="chat">
  <header style="background:#202c33; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
    <div id="statusDot" style="width:10px; height:10px; border-radius:50%; background:gray;"></div>
    <div id="statusText">Offline</div>
  </header>

  <div id="messages"></div>

  <div id="emojiPanel"></div>

  <div id="inputArea">
    <div id="emojiBtn">😊</div>
    <input id="msgInput" placeholder="Type a message" autocomplete="off" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, onDisconnect, update } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAxb8vACQClmiEsB886aaHFMAitu0wEVQo",
    authDomain: "ummchat009.firebaseapp.com",
    projectId: "ummchat009",
    storageBucket: "ummchat009.firebasestorage.app",
    messagingSenderId: "880860486384",
    appId: "1:880860486384:web:85ce4f7ccb70eb1c5f8035"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Example user/pass list:
  const validUsers = {
    "bappy": "1234",
    "user1": "abcd"
  };

  // Elements
  const loginDiv = document.getElementById('login');
  const chatDiv = document.getElementById('chat');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const emojiPanel = document.getElementById('emojiPanel');
  const emojiBtn = document.getElementById('emojiBtn');

  let userId = null;
  let chatId = "global_chat"; // everyone shares the same chat room here for simplicity

  // Login Logic
  loginBtn.onclick = () => {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if(validUsers[user] && validUsers[user] === pass) {
      userId = user;
      loginDiv.style.display = 'none';
      chatDiv.style.display = 'flex';
      loginMsg.textContent = '';
      initChat();
    } else {
      loginMsg.textContent = 'Invalid username or password!';
    }
  };

  // Chat Logic
  function initChat() {
    const statusRef = ref(db, 'status/' + userId);
    const chatRef = ref(db, 'chats/' + chatId);

    set(statusRef, { state: 'online', lastSeen: Date.now() });
    onDisconnect(statusRef).set({ state: 'offline', lastSeen: Date.now() });

    onValue(ref(db, '.info/connected'), snap => {
      if (snap.val()) {
        statusDot.style.background = 'limegreen';
        statusText.textContent = 'Online';
      } else {
        statusDot.style.background = 'gray';
        statusText.textContent = 'Offline';
      }
    });

    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if(!text) return;
      const msgRef = push(chatRef);
      set(msgRef, {
        userId,
        data: text,
        timestamp: Date.now()
      });
      msgInput.value = '';
    };

    onValue(chatRef, snap => {
      messagesDiv.innerHTML = '';
      snap.forEach(child => {
        const msg = child.val();
        const div = document.createElement('div');
        div.className = 'msg ' + (msg.userId === userId ? 'me' : 'friend');
        div.textContent = msg.data;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Emoji code
    const emojiList = ["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","🥰","😗","😙","😚","🙂","🤗","🤩","🤔","🤨","😐","😑","😶","🙄","😏","😣","😥","😮","🤐","😯","😪","😫","😴","😌","😛","😜","😝","🤤","😒","😓","😔","😕","🙃","🤑","😲","☹️","🙁","😖","😞","😟","😤","😢","😭","😦","😧","😨","😩","🤯","😬","😰","😱","🥵","🥶","😳","🤪","😵","😡","😠","🤬","😷","🤒","🤕","🤢","🤮","🤧","😇","🥳","🥴","🥺","🤠","🤡","🤥","🤫","🤭","🧐"];

    emojiBtn.onclick = () => {
      if(emojiPanel.style.display === 'block'){
        emojiPanel.style.display = 'none';
      } else {
        emojiPanel.innerHTML = '';
        emojiList.forEach(e => {
          const span = document.createElement('span');
          span.textContent = e;
          span.onclick = () => {
            msgInput.value += e;
            msgInput.focus();
          };
          emojiPanel.appendChild(span);
        });
        emojiPanel.style.display = 'block';
      }
    };

    // Hide emoji panel if clicked outside
    document.addEventListener('click', e => {
      if(!emojiPanel.contains(e.target) && e.target !== emojiBtn){
        emojiPanel.style.display = 'none';
      }
    });
  }
</script>

</body>
</html>
