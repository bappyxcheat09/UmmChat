<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Mini Chat Login</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #121212; /* Dark background for the overall app */
    color: #eee;
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden; /* Prevent body scroll */
  }

  /* --- Login Section Styling --- */
  #login {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a); /* Subtle dark gradient */
    width: 90vw;
    max-width: 380px; /* Slightly smaller for professionalism */
    border-radius: 15px; /* More rounded */
    padding: 30px; /* More padding */
    /* Updated: Pink border and shadow for login */
    border: 1px solid #ff69b4; /* Light pink border */
    box-shadow: 0 8px 30px rgba(255, 105, 180, 0.4); /* Pink glow shadow */
    animation: fadeIn 0.7s ease-out forwards; /* Slightly slower fade-in */
    display: flex; /* Flexbox for better alignment */
    flex-direction: column;
    align-items: center; /* Center content */
  }

  #login h2 {
    font-size: 1.8em;
    font-weight: 700;
    color: #f0f0f0; /* Lighter color for contrast */
    margin-bottom: 25px; /* More space below title */
    text-align: center;
    letter-spacing: 0.5px; /* Slight letter spacing for style */
  }

  #login input {
    width: 100%;
    padding: 12px 0; /* Adjust padding */
    margin: 10px 0;
    background: transparent; /* Transparent background */
    border: none;
    border-bottom: 2px solid #555; /* Clean bottom border */
    border-radius: 0; /* No border-radius */
    color: #eee;
    font-size: 17px;
    transition: border-bottom-color 0.3s ease, box-shadow 0.3s ease;
  }

  #login input::placeholder {
    color: #aaa; /* Lighter placeholder color */
  }

  #login input:focus {
    outline: none;
    border-bottom-color: #ff69b4; /* Pink border on focus */
    box-shadow: 0 1px 0 0 #ff69b4; /* Subtle shadow for depth on focus */
  }

  #login button {
    width: 100%;
    background: linear-gradient(45deg, #ff69b4, #e652a2); /* Gradient button */
    border: none;
    padding: 16px; /* Larger padding */
    border-radius: 30px; /* Pill-shaped button */
    font-weight: 700; /* Bolder text */
    color: #fff;
    font-size: 18px; /* Larger font size */
    cursor: pointer;
    margin-top: 30px; /* More space above button */
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4); /* Pink glow shadow */
    letter-spacing: 0.5px;
  }

  #login button:hover {
    background: linear-gradient(45deg, #e652a2, #ff69b4); /* Reverse gradient on hover */
    transform: translateY(-2px) scale(1.02); /* Lift and slightly enlarge */
    box-shadow: 0 8px 20px rgba(255, 105, 180, 0.6);
  }
  #login button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(255, 105, 180, 0.3);
  }

  #loginError {
    color: #ff5255;
    text-align: center;
    margin-top: 20px; /* More margin */
    font-size: 16px;
    font-weight: 500;
  }
  /* --- End Login Section Styling --- */


  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #chat {
    display: none;
    flex-direction: column;
    width: 100vw; /* Occupy full width on mobile */
    height: 100vh; /* Occupy full height on mobile */
    max-width: 550px; /* Slightly smaller max width for desktop screens */
    max-height: 750px; /* Slightly smaller max height for desktop screens */
    background-color: #1a1a1a; /* Darker background for the chat window itself */
    border-radius: 0; /* No border-radius for full screen */
    box-shadow: none; /* No shadow for full screen */
    overflow: hidden; /* Ensure content stays within */
    position: relative; /* For emoji picker positioning */
  }

  @media (min-width: 600px) { /* Apply border-radius and shadow for larger screens */
    #chat {
      border-radius: 12px;
      /* Updated: Pink border and shadow for chat on larger screens */
      border: 1px solid #ff69b4; /* Light pink border */
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4); /* Pink glow shadow */
    }
  }

  .chat-header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px 20px;
    background-color: #202c33;
    border-bottom: 1px solid #333;
  }

  .glowing-title {
    font-size: 1.5em;
    font-weight: 700;
    color: #ff69b4; /* Pinkish glow for love theme */
    text-shadow: 0 0 5px #ff69b4, 0 0 10px #ff69b4, 0 0 20px #ff69b4, 0 0 40px #ff69b4;
    animation: glow 1.8s ease-in-out infinite alternate;
    margin: 0;
    flex-grow: 1;
    text-align: center;
  }

  @keyframes glow {
    from {
      text-shadow: 0 0 5px #ff69b4, 0 0 10px #ff69b4, 0 0 20px #ff69b4, 0 0 40px #ff69b4;
    }
    to {
      text-shadow: 0 0 8px #ff69b4, 0 0 15px #ff69b4, 0 0 30px #ff69b4, 0 0 60px #ff69b4;
    }
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background:
      radial-gradient(circle at 20% 80%, rgba(255, 105, 180, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(255, 160, 180, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(255, 192, 203, 0.08) 0%, transparent 60%); /* Multiple subtle radial gradients */
    background-size: 300% 300%; /* Large background size for movement */
    background-position: 0% 0%; /* Initial position */
    animation: moveLoveBackground 25s ease-in-out infinite alternate; /* Slow, gentle animation */
    border-radius: 0;
    margin-bottom: 0;
    position: relative;
    overflow-x: hidden;
  }

  @keyframes moveLoveBackground {
    0% { background-position: 0% 0%; }
    25% { background-position: 50% 100%; }
    50% { background-position: 100% 0%; }
    75% { background-position: 50% 0%; }
    100% { background-position: 0% 100%; }
  }


  .msg {
    margin-bottom: 8px;
    padding: 10px 12px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.4;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
  }
  .me {
    background: #075e54; /* WhatsApp sent message color (dark green) */
    color: #fff; /* White text for sent messages */
    margin-left: auto;
    border-bottom-right-radius: 3px;
  }
  .other {
    background: #262d31; /* WhatsApp received message color (dark gray/blue) */
    color: #fff; /* White text for received messages */
    margin-right: auto;
    border-bottom-left-radius: 3px;
  }
  #inputArea {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    padding: 10px 15px;
    background-color: #202c33;
    border-top: 1px solid #333;
    position: relative;
  }

  #msgInput {
    flex: 1;
    padding: 12px 15px;
    border-radius: 25px;
    background: #2b2b2b;
    color: #eee;
    font-size: 16px;
    box-shadow: none;
    min-height: 48px;
    resize: none;
    overflow-y: auto;
  }
  #msgInput:focus {
    box-shadow: 0 0 0 2px #ff69b4;
  }

  .emoji-button, #sendBtn {
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 50%;
    margin-top: 0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    font-size: 0;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    cursor: pointer;
    background: #ff69b4; /* Pink */
    color: #fff;
    transition: background 0.2s ease-in-out;
  }
  .emoji-button:hover, #sendBtn:hover {
    background: #e652a2; /* Darker pink on hover */
  }

  .emoji-button::before {
    content: '😊';
    font-size: 22px;
    line-height: 1;
  }

  #sendBtn::before {
    content: '➤';
    font-size: 20px;
    color: #fff;
    line-height: 1;
    transform: rotate(45deg) translateY(-2px) translateX(2px);
  }

  /* Emoji Picker Styles */
  #emojiPickerContainer {
    position: absolute;
    bottom: 70px;
    left: 15px;
    right: 15px;
    background-color: #2c3e50;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
    gap: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    opacity: 0;
    transform: translateY(20px);
    visibility: hidden;
    transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s;
  }

  #emojiPickerContainer.show {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }

  .emoji-item {
    font-size: 22px;
    cursor: pointer;
    text-align: center;
    padding: 5px;
    border-radius: 5px;
    transition: background-color 0.1s ease;
  }
  .emoji-item:hover {
    background-color: #34495e;
  }
</style>
</head>
<body>

<div id="login">
  <h2>Login to Chat</h2>
  <input type="text" id="username" placeholder="Username" autocomplete="off" />
  <input type="password" id="password" placeholder="Password" autocomplete="off" />
  <button id="loginBtn">Login</button>
  <div id="loginError"></div>
</div>

<div id="chat">
  <div class="chat-header">
    <h2 class="glowing-title">BAPPY AND NABILAS CHATS</h2>
  </div>
  <div id="messages"></div>
  <div id="inputArea">
    <button class="emoji-button" id="toggleEmojiPicker"></button>
    <textarea id="msgInput" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
    <button id="sendBtn"></button>
    <div id="emojiPickerContainer"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  // Fixed usernames and passwords
  const validUsers = {
    "bappy": "1234",
    "user1": "abcd",
    "nabil": "5678"
  };

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAxb8vACQClmiEsB886aaHFMAitu0wEVQo",
    authDomain: "ummchat009.firebaseapp.com",
    databaseURL: "https://ummchat009-default-rtdb.firebaseio.com/",
    projectId: "ummchat009",
    storageBucket: "ummchat009.appspot.com",
    messagingSenderId: "880860486384",
    appId: "1:880860486384:web:85ce4f7ccb70eb1c5f8035"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRoom = "global_chat";

  // Get elements
  const loginDiv = document.getElementById('login');
  const chatDiv = document.getElementById('chat');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const toggleEmojiPickerBtn = document.getElementById('toggleEmojiPicker');
  const emojiPickerContainer = document.getElementById('emojiPickerContainer');

  let currentUser = null;
  const LOCAL_STORAGE_USERNAME_KEY = 'chatAppUsername';

  // --- Emoji Data (Expanded) ---
  const emojis = [
    '😀', '😁', '😂', '🤣', '😃', '😄', '😅', '😆', '😉', '😊', '😋', '😎', '😍', '😘', '😗', '😙', '😚', '🤗', '🤔', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐', '😕', '😟', '🙁', '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😩', '😫', '😤', '😠', '😡', '🤬', '😈', '👿', '💀', '☠️', '💩', '🤡', '👹', '👺', '👻', '👽', '👾', '🤖', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿', '😾', '👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦵', '🦶', '👂', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '❤️', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤', '🤍', '💔', '❣️', '💕', '💞', '💗', '💖', '💘', '💓', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤', '🤍', '💌', '💥', '💫', '💥', '✨', '🌟', '💫', '🔥', '💯', '🌈', '☀️', '☔', '☁️', '❄️', '☃️', '⚡', '💧', '🌊', '💨', '🌀', '🌎', '🌍', '🌏', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔', '🌙', '⭐', '🌟', '💫', '✨', '☄️', '🚀', '🛸', '🛰️', '💡', '🔦', '🔋', '🔌', '💻', '🖥️', '⌨️', '🖱️', '🖨️', '📱', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🎤', '🎧', '🎼', '🎵', '🎶', '🎷', '🎺', '🎸', '🎹', '🎻', '🥁', '🎬', '🎥', '📸', '📹', '💡', '📓', '📔', '📒', '📚', '📖', '🔖', '🏷️', '💰', '💳', '💎', '📈', '📉', '📊', '🔔', '🔕', '📢', '📣', '💬', '💭', '🫂', '🚶‍♀️', '🚶‍♂️', '🏃‍♀️', '🏃‍♂️', '💃', '🕺', '👨‍👩‍👧‍👦', '👨‍👩‍👧', '👩‍👩‍👧', '👨‍👨‍👧', '👨‍👩‍👦‍👦', '👨‍👨‍👦‍👦', '👩‍👩‍👦‍👦', '👨‍👩‍👧‍👦', '👨‍👩‍👧‍👧', '👩‍👩‍👧‍👧', '👨‍👨‍👧‍👧', '👨‍👩‍👦', '👩‍👩‍👦', '👨‍👨‍👦', '👥', '🧑‍🤝‍🧑', '🫂', '🏡', '🏠', '🏘️', '🏢', '🏗️', '🏭', '⛪', '🕌', '🛕', '🕍', '⛩️', '🏬', '🏪', '🏫', '🎡', '🎢', '🎠', '⛲', '🗼', '🗽', '🏛️', '⛰️', '🗻', '🏕️', '🏖️', '🏜️', '🏝️', '🏞️', '🛣️', '🛤️', '🚂', '🚃', '🚄', '🚅', '🚆', '🚇', '🚈', '🚉', '🚊', '🚗', '🚘', '🚌', '🚍', '🚎', '🚐', '🚑', '🚒', '🚓', '🚔', '🚕', '🚖', '🚗', '🚙', '🚚', '🚛', '🚜', '🛵', '🚲', '🛴', '🛹', '🛺', '✈️', '🛫', '🛬', '💺', '🚁', '🚟', '🚠', '🚡', '🚢', '🛥️', '🚤', '⛵', '🛶', '⛴️', '🛳️', '⚓', '🌠', '🎇', '🎆', '🎑', '🌅', '🌄', '🌆', '🌃', '🌉', '🌁', '⌚', '📱', '💻', '🖥️', '⌨️', '🖱️', '🖨️', '💾', '💿', '📀', '💽', '📼', '📷', '📸', '📹', '🎥', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🎤', '🎧', '🎼', '🎵', '🎶', '🎷', '🎺', '🎸', '🎹', '🎻', '🥁', '🎬', '🎥', '📸', '📹', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🎤', '🎧', '🎼', '🎵', '🎶', '🎷', '🎺', '🎸', '🎹', '🎻', '🥁', '🎯', '🎳', '🎱', '🎲', '♟️', '🎮', '🎰', '🧩', '🏆', '🏅', '🥇', '🥈', '🥉', '⚽', '⚾', '🥎', '🏀', '🏐', '🏈', '🏉', '🎾', '🥏', '🪃', '🏏', '🏑', '🏒', '🥍', '🏓', '🏸', '🥊', '🥋', '🥅', '⛳', '⛸️', '🎣', '🤿', '🎽', '🎿', '🛷', '🥌', '🪢', '🪁', '🛼', '🤿', '🤼‍♀️', '🤼‍♂️', '🤸‍♀️', '🤸‍♂️', '⛹️‍♀️', '⛹️‍♂️', '🤾‍♀️', '🤾‍♂️', '🤺', '🏋️‍♀️', '🏋️‍♂️', '🧘‍♀️', '🧘‍♂️', '🛀', '🛌', '🛋️', '🪑', '🚽', '🚿', '🛁', '🧼', '🪥', '🪒', '🧺', '🧻', '🚽', '🧹', '🪣', '🧴', '🧽', '🧼', '🧺', '🪣', '🧴', '🧽', '🗝️', '🔑', '🚪', '🪞', '🪟', '🛏️', '🪟', '🪑', '🚽', '🚿', '🛁', '🧼', '🪥', '🪒', '🧺', '🧻', '🚽', '🧹', '🪣', '🧴', '🧽', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🌽', '🥕', '🥔', '🍠', '🥐', '🍞', '🥖', '🥨', '🥯', '🥞', '🧇', '🧀', '🍖', '🍗', '🥩', '🥓', '🍔', '🍟', '🍕', '🌭', '🥪', '🌮', '🌯', '🥙', '🧆', '🥚', '🍳', '🍲', '🥣', '🥗', '🍿', '🧈', '🧂', '🥫', '🍱', '🍘', '🍙', '🍚', '🍛', '🍜', '🍝', '🍠', '🍢', '🍣', '🍤', '🍥', '🥮', '🍡', '🥟', '🥠', '🥡', '🍦', '🍧', '🍨', '🍩', '🍪', '🎂', '🍰', '🧁', '🥧', '🍫', '🍬', '🍭', '🍮', '🍯', '🍼', '🥛', '☕', '🍵', '🍶', '🍾', '🍷', '🍸', '🍹', '🍺', '🍻', '🥂', '🥃', '🥤', '🧉', '🧊', '🥄', '🍴', '🍽️', '🥣', '🥡', '🥢', '🍚', '🥫', '🍿', '🧊', '🧉', '🥤', '🥃', '🥂', '🍻', '🍺', '🍹', '🍸', '🍷', '🍾', '🍶', '🍵', '☕', '🥛', '🍼', '🍯', '🍮', '🍭', '🍬', '🍫', '🥧', '🧁', '🍰', '🎂', '🍪', '🍩', '🍨', '🍧', '🍦', '🥡', '🥠', '🥟', '🍡', '🥮', '🍥', '🍤', '🍣', '🍢', '🍠', '🍝', '🍜', '🍛', '🍚', '🍙', '🍘', '🍱', '🥫', '🧂', '🧈', '🍿', '🥗', '🥣', '🍲', '🍳', '🥚', '🧆', '🥙', '🌯', '🌮', '🥪', '🌭', '🍕', '🍟', '🍔', '🥓', '🥩', '🍗', '🍖', '🧀', '🧇', '🥞', '🥯', '🥨', '🥖', '🍞', '🥐', '🍠', '🥕', '🌽', '🌶️', '🥒', '🥬', '🥦', '🥑', '🍆', '🍅', '🥝', '🥥', '🍍', '🥭', '🍑', '🍒', '🍈', '🍓', '🍇', '🍉', '🍌', '🍋', '🍊', '🍐', '🍎', '🐕', '🐈', '🐁', '🐀', '🐹', '🐰', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🐒', '🐶', '🐺', '🦊', '🦝', '🐈', '🐅', '🐆', '🐎', '🦓', '🦌', '🦬', '🐃', '🐂', '🐄', '🐷', '🐗', '🐏', '🐑', '🐐', '🐪', '🐫', '🦙', '🦒', '🐘', '🦏', '🦛', '🐭', '🐁', '🐀', '🐹', '🐰', '🐿️', '🦔', '🦇', '🐻', '🐨', '🐼', '🦥', '🦦', '🦨', '🦘', '🦡', '🐾', '🦃', '🐔', '🐓', '🐣', '🐤', '🐥', '🐦', '🐧', '🕊️', '🦅', '🦆', '🦢', '🦉', '🦩', '🦚', '🦜', '🐸', '🐊', '🐢', '🦎', '🐍', '🐲', '🐉', '🦕', '🦖', '🐳', '🐋', '🐬', '🐟', '🐠', '🐡', '🦈', '🐙', '🐚', '🐌', '🦋', '🐛', '🐜', '🐝', '🐞', '🦗', '🕷️', '🕸️', '🦂', '🦟', '🦠', '💐', '🌸', '💮', '🌹', '🥀', '🌺', '🌻', '🌼', '🌷', '🌱', '🌲', '🌳', '🌴', '🌵', '🌾', '☘️', '🍀', '🍁', '🍂', '🍃', '🍄', '🌰', '🌍', '🌎', '🌏', '🌐', '🗺️', '🧭', '🏔️', '⛰️', '🌋', '🗻', '🏕️', '🏖️', '🏜️', '🏝️', '🏞️', '🏘️', '🏡', '🏠', '🏢', '🏣', '🏤', '🏥', '🏦', '🏨', '🏩', '🏫', '🏪', '🏭', '⛪', '🕌', '🕍', '⛩️', '🕋', '⛲', '🏛️', ' برج', '🗼', '🗽', '🌉', '🛣️', ' rail', '🚂', '🚃', '🚄', '🚅', '🚆', '🚇', '🚈', '🚉', '🚊', '🚝', '🚞', '🚋', '🚌', '🚍', '🚎', '🚐', '🚑', '🚒', '🚓', '🚔', '🚕', '🚖', '🚗', '🚙', '🚚', '🚛', '🚜', '🛵', '🚲', '🛴', '🛹', '🛺', '🚦', '🚧', '🛑', '🚨', '✈️', '🛫', '🛬', '💺', '🚁', '🚟', '🚠', '🚡', '🚢', '🛥️', '🚤', '⛵', '🛶', '⛴️', '🛳️', '⚓', '🌠', '🎇', '🎆', '🎑', '🌅', '🌄', '🌆', '🌃', '🌉', '🌁', '⌚', '📱', '💻', '🖥️', '⌨️', '🖱️', '🖨️', '💾', '💿', '📀', '💽', '📼', '📷', '📸', '📹', '🎥', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🎤', '🎧', '🎼', '🎵', '🎶', '🎷', '🎺', '🎸', '🎹', '🎻', '🥁', '🎯', '🎳', '🎱', '🎲', '♟️', '🎮', '🎰', '🧩', '🏆', '🏅', '🥇', '🥈', '🥉', '⚽', '⚾', '🥎', '🏀', '🏐', '🏈', '🏉', '🎾', '🥏', '🪃', '🏏', '🏑', '🏒', '🥍', '🏓', '🏸', '🥊', '🥋', '🥅', '⛳', '⛸️', '🎣', '🤿', '🎽', '🎿', '🛷', '🥌', '🪢', '🪁', '🛼', '🤿', '🤼‍♀️', '🤼‍♂️', '🤸‍♀️', '🤸‍♂️', '⛹️‍♀️', '⛹️‍♂️', '🤾‍♀️', '🤾‍♂️', '🤺', '🏋️‍♀️', '🏋️‍♂️', '🧘‍♀️', '🧘‍♂️', '🛀', '🛌', '🛋️', '🪑', '🚽', '🚿', '🛁', '🧼', '🪥', '🪒', '🧺', '🧻', '🚽', '🧹', '🪣', '🧴', '🧽', '🧼', '🧺', '🪣', '🧴', '🧽', '🗝️', '🔑', '🚪', '🪞', '🪟', '🛏️', '🪟', '🪑', '🚽', '🚿', '🛁', '🧼', '🪥', '🪒', '🧺', '🧻', '🚽', '🧹', '🪣', '🧴', '🧽'
  ];


  // Function to load user from local storage
  function loadUserFromLocalStorage() {
    const storedUsername = localStorage.getItem(LOCAL_STORAGE_USERNAME_KEY);
    if (storedUsername && validUsers[storedUsername]) {
      currentUser = storedUsername;
      loginDiv.style.display = 'none';
      chatDiv.style.display = 'flex';
      startChat();
      return true;
    }
    return false;
  }

  // Attempt to load user on page load
  if (!loadUserFromLocalStorage()) {
    loginDiv.style.display = 'flex';
  }

  loginBtn.onclick = () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (validUsers[username] && validUsers[username] === password) {
      currentUser = username;
      localStorage.setItem(LOCAL_STORAGE_USERNAME_KEY, currentUser);
      loginDiv.style.display = 'none';
      chatDiv.style.display = 'flex';
      loginError.textContent = '';
      startChat();
      requestNotificationPermission(); // Added: Request notification permission on successful login
    } else {
      loginError.textContent = 'Invalid username or password!';
      usernameInput.value = '';
      passwordInput.value = '';
      usernameInput.focus();
    }
  };

  // --- Notification Functionality ---
  function requestNotificationPermission() {
    if (!("Notification" in window)) {
      console.log("This browser does not support desktop notification");
    } else if (Notification.permission === "granted") {
      console.log("Notification permission already granted.");
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("Notification permission granted.");
        } else {
          console.log("Notification permission denied.");
        }
      });
    }
  }

  function showNotification(sender, messageText) {
    if (Notification.permission === "granted" && document.hidden) { // Only show notification if tab is not active
      const title = "BAPPY MESSAGE DICHE FAST CHECK KORO"; // Your custom title
      const options = {
        body: `${sender}: ${messageText}`, // Message body
        icon: 'https://www.flaticon.com/svg/vst/2922/2922510.svg' // You can replace this with a real icon path
      };
      new Notification(title, options);
    }
  }
  // --- End Notification Functionality ---


  function startChat() {
    const chatRef = ref(db, "chats/" + chatRoom);

    onValue(chatRef, (snapshot) => {
      let lastMessage = null;
      messagesDiv.innerHTML = '';
      snapshot.forEach(child => {
        const msg = child.val();
        lastMessage = msg; // Keep track of the last message
        const div = document.createElement('div');
        div.classList.add('msg');
        div.classList.add(msg.user === currentUser ? 'me' : 'other');
        div.textContent = `${msg.user}: ${msg.text}`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // Show notification if a new message arrives and it's not from the current user
      if (lastMessage && lastMessage.user !== currentUser) {
        showNotification(lastMessage.user, lastMessage.text);
      }
    });

    // --- Message Sending Logic ---
    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      const chatRefPush = ref(db, "chats/" + chatRoom);
      push(chatRefPush, {
        user: currentUser,
        text: text,
        timestamp: Date.now()
      });
      msgInput.value = ''; // Clear input field after sending
      msgInput.style.height = 'auto'; // Reset textarea height
      msgInput.focus();
    }

    sendBtn.onclick = sendMessage;

    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter, new line on Shift+Enter
        e.preventDefault(); // Prevent default Enter key behavior (new line)
        sendMessage();
      }
    });

    // --- Auto-resize textarea for multi-line input ---
    msgInput.addEventListener('input', () => {
      msgInput.style.height = 'auto';
      msgInput.style.height = msgInput.scrollHeight + 'px';
    });


    // --- Emoji Picker Logic ---
    function populateEmojiPicker() {
      emojiPickerContainer.innerHTML = ''; // Clear previous emojis
      emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.classList.add('emoji-item');
        span.textContent = emoji;
        span.onclick = () => {
          const start = msgInput.selectionStart;
          const end = msgInput.selectionEnd;
          const text = msgInput.value;
          msgInput.value = text.substring(0, start) + emoji + text.substring(end);
          msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
          msgInput.focus();
          msgInput.dispatchEvent(new Event('input')); // Trigger input event for auto-resize
          emojiPickerContainer.classList.remove('show'); // Hide picker after selection
        };
        emojiPickerContainer.appendChild(span);
      });
    }

    toggleEmojiPickerBtn.onclick = (event) => {
      event.stopPropagation(); // Prevent click from bubbling to document and closing picker
      emojiPickerContainer.classList.toggle('show');
      if (emojiPickerContainer.classList.contains('show')) {
        populateEmojiPicker(); // Populate only when shown
      }
    };

    // Close emoji picker if clicked outside or on a message
    document.addEventListener('click', (event) => {
      if (!emojiPickerContainer.contains(event.target) && event.target !== toggleEmojiPickerBtn && !event.target.closest('.msg')) {
        emojiPickerContainer.classList.remove('show');
      }
    });

    // Prevent emoji picker from closing when clicking inside it
    emojiPickerContainer.addEventListener('click', (event) => {
      event.stopPropagation();
    });
  }
</script>

</body>
</html>
